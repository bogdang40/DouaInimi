{% extends 'base.html' %}

{% block title %}Discover - {{ app_name }}{% endblock %}

{% block main_class %}pb-20 md:pb-0{% endblock %}

{% block extra_css %}
<style>
    .swipe-card {
        transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .swipe-card.swiping-left {
        transform: translateX(-100%) rotate(-20deg);
        opacity: 0;
    }
    .swipe-card.swiping-right {
        transform: translateX(100%) rotate(20deg);
        opacity: 0;
    }
    @keyframes pulse-heart {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.2); }
    }
    .animate-heart {
        animation: pulse-heart 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-[calc(100vh-64px)] bg-surface-50 dark:bg-surface-950 flex items-center justify-center p-4">
    <div class="w-full max-w-md">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <h1 class="font-display text-2xl font-bold text-surface-900 dark:text-white">Discover</h1>
            <div class="flex space-x-2">
                <a href="{{ url_for('discover.browse') }}" 
                   class="p-2 bg-white dark:bg-white/5 border border-surface-200 dark:border-white/10 rounded-lg text-surface-600 dark:text-gray-400 hover:bg-surface-50 dark:hover:bg-white/10"
                   title="Grid View">
                    <i data-lucide="grid" class="w-5 h-5"></i>
                </a>
                <a href="{{ url_for('discover.search') }}" 
                   class="p-2 bg-white dark:bg-white/5 border border-surface-200 dark:border-white/10 rounded-lg text-surface-600 dark:text-gray-400 hover:bg-surface-50 dark:hover:bg-white/10"
                   title="Filters">
                    <i data-lucide="sliders" class="w-5 h-5"></i>
                </a>
            </div>
        </div>
        
        {% if users %}
        <!-- Card Stack -->
        <div id="card-stack" class="relative h-[500px] sm:h-[550px]">
            {% for user in users %}
            {% set profile = user.profile %}
            <div class="swipe-card absolute inset-0 bg-white dark:bg-surface-800 rounded-3xl shadow-2xl overflow-hidden border border-surface-200 dark:border-white/10"
                 data-user-id="{{ user.id }}"
                 style="z-index: {{ loop.revindex }}; {% if not loop.first %}display: none;{% endif %}">
                
                <!-- Photo -->
                <div class="relative h-[65%]">
                    <img src="{{ user.primary_photo_url }}" 
                         alt="{{ user.display_name }}"
                         class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent"></div>
                    
                    <!-- Like/Nope overlays -->
                    <div class="like-overlay absolute inset-0 bg-green-500/20 flex items-center justify-center opacity-0 transition-opacity">
                        <span class="text-6xl">üíö</span>
                    </div>
                    <div class="nope-overlay absolute inset-0 bg-red-500/20 flex items-center justify-center opacity-0 transition-opacity">
                        <span class="text-6xl">‚ùå</span>
                    </div>
                    
                    <!-- Info overlay -->
                    <div class="absolute bottom-0 left-0 right-0 p-6">
                        <h2 class="font-display text-3xl font-bold text-white">
                            {{ user.display_name }}{% if profile and profile.age %}, {{ profile.age }}{% endif %}
                        </h2>
                        {% if profile %}
                        <p class="text-white/80 flex items-center mt-1">
                            <i data-lucide="map-pin" class="w-4 h-4 mr-1"></i>
                            {{ profile.city }}{% if profile.state_province %}, {{ profile.state_province }}{% endif %}
                        </p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Details -->
                <div class="p-6">
                    {% if profile %}
                    <div class="flex flex-wrap gap-2 mb-4">
                        {% if profile.denomination %}
                        <span class="inline-flex items-center px-3 py-1 bg-teal-100 dark:bg-teal-500/20 text-teal-700 dark:text-teal-400 rounded-full text-sm">
                            ‚úùÔ∏è {{ dict(config['DENOMINATIONS']).get(profile.denomination, profile.denomination) }}
                        </span>
                        {% endif %}
                        {% if profile.speaks_romanian %}
                        <span class="inline-flex items-center px-3 py-1 bg-amber-100 dark:bg-amber-500/20 text-amber-700 dark:text-amber-400 rounded-full text-sm">
                            üá∑üá¥ {{ profile.get_speaks_romanian_display() }}
                        </span>
                        {% endif %}
                    </div>
                    
                    {% if profile.bio %}
                    <p class="text-surface-600 dark:text-gray-400 text-sm line-clamp-2">
                        {{ profile.bio[:100] }}{% if profile.bio|length > 100 %}...{% endif %}
                    </p>
                    {% endif %}
                    {% endif %}
                    
                    <a href="{{ url_for('profile.view_user', user_id=user.id) }}" 
                       class="block text-center text-amber-600 dark:text-amber-400 text-sm mt-3 hover:underline">
                        View Full Profile
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Action Buttons -->
        <div class="flex justify-center items-center space-x-4 mt-6">
            <button id="btn-pass" 
                    class="w-14 h-14 sm:w-16 sm:h-16 bg-white dark:bg-surface-800 border-2 border-red-200 dark:border-red-500/30 rounded-full flex items-center justify-center text-red-500 shadow-lg hover:scale-110 active:scale-95 transition-transform"
                    title="Pass">
                <i data-lucide="x" class="w-7 h-7 sm:w-8 sm:h-8"></i>
            </button>
            <button id="btn-super-like"
                    class="w-12 h-12 sm:w-14 sm:h-14 bg-gradient-to-r from-blue-400 to-blue-500 rounded-full flex items-center justify-center text-white shadow-lg hover:scale-110 active:scale-95 transition-transform relative"
                    title="Super Like ({{ super_likes_remaining }} remaining)">
                <i data-lucide="star" class="w-6 h-6 sm:w-7 sm:h-7"></i>
                <span id="super-like-count" class="absolute -top-1 -right-1 w-5 h-5 bg-amber-500 text-white text-xs rounded-full flex items-center justify-center font-bold">
                    {{ super_likes_remaining }}
                </span>
            </button>
            <button id="btn-like" 
                    class="w-14 h-14 sm:w-16 sm:h-16 bg-gradient-to-r from-green-400 to-green-500 rounded-full flex items-center justify-center text-white shadow-lg hover:scale-110 active:scale-95 transition-transform"
                    title="Like">
                <i data-lucide="heart" class="w-7 h-7 sm:w-8 sm:h-8"></i>
            </button>
        </div>
        
        <!-- Info button moved below -->
        <div class="flex justify-center mt-4">
            <button id="btn-info"
                    class="px-4 py-2 bg-white dark:bg-surface-800 border border-surface-200 dark:border-white/10 rounded-full flex items-center space-x-2 text-surface-500 dark:text-gray-400 hover:bg-surface-50 dark:hover:bg-white/5 transition text-sm">
                <i data-lucide="info" class="w-4 h-4"></i>
                <span>View Profile</span>
            </button>
        </div>
        
        <!-- Cards remaining -->
        <p class="text-center text-surface-500 dark:text-gray-500 text-sm mt-4">
            <span id="cards-remaining">{{ users|length }}</span> profiles to discover
        </p>
        
        {% else %}
        <!-- No more profiles -->
        <div class="text-center py-16 bg-white dark:bg-white/5 border border-surface-200 dark:border-white/10 rounded-3xl">
            <div class="w-24 h-24 bg-amber-100 dark:bg-amber-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
                <span class="text-5xl">üîç</span>
            </div>
            <h2 class="font-display text-2xl font-bold text-surface-900 dark:text-white mb-2">No More Profiles</h2>
            <p class="text-surface-600 dark:text-gray-400 max-w-sm mx-auto mb-6">
                You've seen all available profiles. Try adjusting your filters or check back later!
            </p>
            <a href="{{ url_for('discover.search') }}" 
               class="inline-flex items-center px-5 py-2.5 bg-gradient-to-r from-amber-500 to-amber-600 text-white rounded-full hover:from-amber-400 hover:to-amber-500 transition">
                <i data-lucide="sliders" class="w-4 h-4 mr-2"></i>
                Adjust Filters
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Match Modal -->
<div id="match-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-surface-800 rounded-3xl p-8 max-w-sm mx-4 text-center transform scale-95 opacity-0 transition-all" id="match-modal-content">
        <div class="text-6xl mb-4">üéâüíïüéâ</div>
        <h2 class="font-display text-3xl font-bold text-surface-900 dark:text-white mb-2">It's a Match!</h2>
        <p class="text-surface-600 dark:text-gray-400 mb-6">You and <span id="match-name" class="font-semibold text-amber-600 dark:text-amber-400"></span> have liked each other!</p>
        <div class="flex space-x-3">
            <button onclick="closeMatchModal()" 
                    class="flex-1 py-3 bg-surface-100 dark:bg-white/5 border border-surface-200 dark:border-white/10 rounded-xl text-surface-700 dark:text-gray-300 hover:bg-surface-200 dark:hover:bg-white/10 transition">
                Keep Swiping
            </button>
            <a href="#" id="match-message-btn"
               class="flex-1 py-3 bg-gradient-to-r from-amber-500 to-amber-600 text-white rounded-xl hover:from-amber-400 hover:to-amber-500 transition">
                Say Hello!
            </a>
        </div>
    </div>
</div>

<script>
(function() {
    const cardStack = document.getElementById('card-stack');
    const btnLike = document.getElementById('btn-like');
    const btnPass = document.getElementById('btn-pass');
    const btnSuperLike = document.getElementById('btn-super-like');
    const btnInfo = document.getElementById('btn-info');
    const cardsRemaining = document.getElementById('cards-remaining');
    const superLikeCount = document.getElementById('super-like-count');
    const matchModal = document.getElementById('match-modal');
    const matchModalContent = document.getElementById('match-modal-content');
    const matchName = document.getElementById('match-name');
    const matchMessageBtn = document.getElementById('match-message-btn');
    
    if (!cardStack) return;
    
    const csrfToken = "{{ csrf_token() }}";
    let cards = cardStack.querySelectorAll('.swipe-card');
    let currentIndex = 0;
    
    function getCurrentCard() {
        return cards[currentIndex];
    }
    
    function showNextCard() {
        currentIndex++;
        updateCardsRemaining();
        
        if (currentIndex < cards.length) {
            cards[currentIndex].style.display = 'block';
        } else {
            // No more cards
            cardStack.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center">
                    <div class="w-24 h-24 bg-amber-100 dark:bg-amber-500/20 rounded-full flex items-center justify-center mb-6">
                        <span class="text-5xl">‚ú®</span>
                    </div>
                    <h2 class="font-display text-2xl font-bold text-surface-900 dark:text-white mb-2">All Done!</h2>
                    <p class="text-surface-600 dark:text-gray-400">Check back later for new profiles.</p>
                </div>
            `;
        }
        lucide.createIcons();
    }
    
    function updateCardsRemaining() {
        cardsRemaining.textContent = Math.max(0, cards.length - currentIndex);
    }
    
    function swipe(direction, isSuper = false) {
        const card = getCurrentCard();
        if (!card) return;
        
        // Haptic feedback on mobile
        if ('vibrate' in navigator) {
            if (isSuper) {
                navigator.vibrate([50, 50, 50, 50, 100]); // Extra vibration for super like
            } else {
                navigator.vibrate(direction === 'right' ? [50, 30, 50] : [30]);
            }
        }
        
        const userId = card.dataset.userId;
        
        // Add animation class
        if (isSuper) {
            card.classList.add('swiping-right');
            card.querySelector('.like-overlay').style.opacity = 1;
            card.querySelector('.like-overlay').innerHTML = '<span class="text-6xl">‚≠ê</span>';
        } else {
            card.classList.add(direction === 'right' ? 'swiping-right' : 'swiping-left');
        }
        
        // Send action to server
        let endpoint;
        if (isSuper) {
            endpoint = `/discover/super-like/${userId}`;
        } else {
            endpoint = direction === 'right' 
                ? `/discover/like/${userId}`
                : `/discover/pass/${userId}`;
        }
        
        const formData = new FormData();
        formData.append('csrf_token', csrfToken);
        formData.append('swipe_mode', 'true');
        
        fetch(endpoint, {
            method: 'POST',
            body: formData
        }).then(response => response.json())
          .then(data => {
              if (data.is_match) {
                  showMatchModal(data.matched_user_name, data.match_id, isSuper);
              }
              // Update super like counter
              if (data.super_likes_remaining !== undefined && superLikeCount) {
                  superLikeCount.textContent = data.super_likes_remaining;
                  if (data.super_likes_remaining === 0) {
                      btnSuperLike.classList.add('opacity-50');
                      btnSuperLike.disabled = true;
                  }
              }
              if (data.error && data.error.includes('No super likes')) {
                  alert('No super likes remaining today! Try again tomorrow.');
              }
          }).catch(err => console.log('Action recorded'));
        
        setTimeout(showNextCard, 300);
    }
    
    function showMatchModal(name, matchId, isSuper = false) {
        matchName.textContent = name;
        matchMessageBtn.href = `/messages/${matchId}`;
        
        // Update modal for super match
        const modalEmoji = matchModal.querySelector('.text-6xl');
        if (modalEmoji) {
            modalEmoji.textContent = isSuper ? '‚≠êüíï‚≠ê' : 'üéâüíïüéâ';
        }
        const modalTitle = matchModal.querySelector('h2');
        if (modalTitle) {
            modalTitle.textContent = isSuper ? "Super Match!" : "It's a Match!";
        }
        matchModal.classList.remove('hidden');
        setTimeout(() => {
            matchModalContent.classList.remove('scale-95', 'opacity-0');
            matchModalContent.classList.add('scale-100', 'opacity-100');
        }, 50);
    }
    
    window.closeMatchModal = function() {
        matchModalContent.classList.add('scale-95', 'opacity-0');
        matchModalContent.classList.remove('scale-100', 'opacity-100');
        setTimeout(() => {
            matchModal.classList.add('hidden');
        }, 200);
    };
    
    // Button handlers
    btnLike.addEventListener('click', () => swipe('right'));
    btnPass.addEventListener('click', () => swipe('left'));
    if (btnSuperLike) {
        btnSuperLike.addEventListener('click', () => swipe('right', true));
    }
    btnInfo.addEventListener('click', () => {
        const card = getCurrentCard();
        if (card) {
            const userId = card.dataset.userId;
            window.location.href = `/profile/user/${userId}`;
        }
    });
    
    // Keyboard controls
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight') swipe('right');
        if (e.key === 'ArrowLeft') swipe('left');
    });
    
    // Touch/drag support (simplified)
    let startX = 0;
    let currentX = 0;
    let isDragging = false;
    
    cardStack.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        isDragging = true;
    });
    
    cardStack.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        currentX = e.touches[0].clientX;
        const diff = currentX - startX;
        const card = getCurrentCard();
        if (card) {
            card.style.transform = `translateX(${diff}px) rotate(${diff * 0.05}deg)`;
            
            // Show overlay based on direction
            if (diff > 50) {
                card.querySelector('.like-overlay').style.opacity = Math.min(1, (diff - 50) / 100);
            } else if (diff < -50) {
                card.querySelector('.nope-overlay').style.opacity = Math.min(1, (-diff - 50) / 100);
            }
        }
    });
    
    cardStack.addEventListener('touchend', (e) => {
        if (!isDragging) return;
        isDragging = false;
        
        const diff = currentX - startX;
        const card = getCurrentCard();
        
        if (Math.abs(diff) > 100) {
            swipe(diff > 0 ? 'right' : 'left');
        } else if (card) {
            card.style.transform = '';
            card.querySelector('.like-overlay').style.opacity = 0;
            card.querySelector('.nope-overlay').style.opacity = 0;
        }
    });
    
    lucide.createIcons();
})();
</script>
{% endblock %}

