{% extends 'base.html' %}

{% block title %}Messages - {{ app_name }}{% endblock %}

{% block main_class %}pb-20 md:pb-0{% endblock %}

{% block footer %}{% endblock %}

{% block extra_css %}
<style>
    /* Conversation row swipe-to-reveal */
    .conv-row {
        position: relative;
        overflow: hidden;
        transition: transform 0.2s ease-out;
    }
    .conv-row-content {
        position: relative;
        z-index: 1;
        background: inherit;
        transition: transform 0.2s ease-out;
    }
    .conv-row-actions {
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        padding-right: 16px;
        background: linear-gradient(90deg, transparent, #ef4444 40%);
        z-index: 0;
        opacity: 0;
        transition: opacity 0.2s;
    }
    .conv-row.swiping .conv-row-actions {
        opacity: 1;
    }

    /* Online pulse animation */
    @keyframes online-pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.7; }
    }
    .online-dot {
        animation: online-pulse 2s ease-in-out infinite;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6 bg-surface-50 dark:bg-transparent min-h-screen">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="font-display text-2xl sm:text-3xl font-bold text-surface-900 dark:text-white">Messages</h1>
        <p class="mt-1 text-sm text-surface-600 dark:text-gray-400">Your conversations</p>
    </div>

    {% if conversations %}
    <div class="bg-white dark:bg-white/5 border border-surface-200 dark:border-white/10 rounded-2xl overflow-hidden">
        {% for conv in conversations %}
        {% set other_user = conv.match.get_other_user(current_user.id) %}
        {% set other_profile = other_user.profile %}
        {% set unread = conv.match.unread_count(current_user.id) %}
        <div class="conv-row {% if not loop.last %}border-b border-surface-100 dark:border-white/5{% endif %}">
            <a href="{{ url_for('messages.conversation', match_id=conv.match.id) }}"
               onclick="if('vibrate' in navigator) navigator.vibrate(5);"
               class="conv-row-content flex items-center p-4 active:bg-surface-100 dark:active:bg-white/10 transition-colors
                      {% if unread > 0 %}bg-amber-50/50 dark:bg-amber-500/5{% else %}bg-white dark:bg-transparent{% endif %}">
                <!-- Avatar with online indicator -->
                <div class="relative flex-shrink-0">
                    <img src="{{ other_user.primary_photo_url }}"
                         alt="{{ other_user.display_name }}"
                         class="w-14 h-14 rounded-full object-cover ring-2
                                {% if unread > 0 %}ring-amber-500{% else %}ring-surface-200 dark:ring-white/10{% endif %}">
                    <!-- Online status -->
                    {% if other_user.is_online %}
                    <div class="absolute bottom-0 right-0 w-4 h-4 bg-green-500 rounded-full border-2 border-white dark:border-surface-900 online-dot"></div>
                    {% endif %}
                    <!-- Unread badge -->
                    {% if unread > 0 %}
                    <div class="absolute -top-1 -right-1 min-w-[20px] h-5 bg-rose-500 text-white text-xs rounded-full flex items-center justify-center font-bold px-1">
                        {{ unread if unread < 100 else '99+' }}
                    </div>
                    {% endif %}
                </div>

                <!-- Content -->
                <div class="ml-4 flex-1 min-w-0">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2 min-w-0">
                            <h3 class="font-semibold truncate
                                       {% if unread > 0 %}text-surface-900 dark:text-white{% else %}text-surface-700 dark:text-gray-300{% endif %}">
                                {{ other_user.display_name }}
                            </h3>
                            <!-- Compatibility badge (compact) -->
                            {% if current_user.profile and other_profile %}
                            {% set compat = current_user.profile.calculate_compatibility(other_profile) %}
                            <span class="hidden sm:inline-flex text-[10px] px-1.5 py-0.5 rounded-full font-medium
                                {% if compat >= 80 %}bg-green-100 dark:bg-green-500/20 text-green-700 dark:text-green-400
                                {% elif compat >= 60 %}bg-amber-100 dark:bg-amber-500/20 text-amber-700 dark:text-amber-400
                                {% else %}bg-surface-100 dark:bg-white/10 text-surface-600 dark:text-gray-400{% endif %}">
                                {{ compat }}%
                            </span>
                            {% endif %}
                        </div>
                        <span class="text-xs text-surface-400 dark:text-gray-500 flex-shrink-0 ml-2">
                            {% if conv.last_message %}
                                {% if conv.last_message.created_at.date() == now.date() %}
                                    {{ conv.last_message.created_at.strftime('%I:%M %p') }}
                                {% else %}
                                    {{ conv.last_message.created_at.strftime('%b %d') }}
                                {% endif %}
                            {% endif %}
                        </span>
                    </div>
                    <p class="text-sm truncate mt-0.5
                              {% if unread > 0 %}text-surface-700 dark:text-gray-300 font-medium{% else %}text-surface-500 dark:text-gray-400{% endif %}">
                        {% if conv.last_message %}
                            {% if conv.last_message.sender_id == current_user.id %}
                                <span class="text-surface-400">You: </span>
                            {% endif %}
                            {{ conv.last_message.content[:50] }}{% if conv.last_message.content|length > 50 %}...{% endif %}
                        {% else %}
                            <span class="text-amber-600 dark:text-amber-400">New match! Say hello ðŸ‘‹</span>
                        {% endif %}
                    </p>
                </div>

                <i data-lucide="chevron-right" class="w-5 h-5 text-surface-300 dark:text-gray-600 flex-shrink-0 ml-2"></i>
            </a>
        </div>
        {% endfor %}
    </div>

    {% else %}
    <!-- Empty State -->
    <div class="text-center py-12 sm:py-16 bg-white dark:bg-white/5 border border-surface-200 dark:border-white/10 rounded-2xl">
        <div class="w-20 h-20 bg-gradient-to-br from-amber-100 to-rose-100 dark:from-amber-500/20 dark:to-rose-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
            <i data-lucide="message-circle" class="w-10 h-10 text-amber-600 dark:text-amber-400"></i>
        </div>
        <h3 class="font-display text-xl sm:text-2xl font-semibold text-surface-900 dark:text-white mb-2">No Messages Yet</h3>
        <p class="text-sm sm:text-base text-surface-600 dark:text-gray-400 max-w-sm mx-auto mb-6 px-4">
            Match with someone to start chatting. Your conversations will appear here.
        </p>
        <a href="{{ url_for('discover.swipe') }}"
           onclick="if('vibrate' in navigator) navigator.vibrate(10);"
           class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-amber-500 to-amber-600 text-white rounded-full hover:from-amber-400 hover:to-amber-500 active:scale-95 transition-all shadow-lg shadow-amber-500/25">
            <i data-lucide="flame" class="w-5 h-5 mr-2"></i>
            Start Swiping
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}
