{% extends "admin/base_admin.html" %}

{% block title %}User Details{% endblock %}
{% block header %}User: {{ user.email }}{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Back Button -->
    <a href="{{ url_for('admin.users') }}" class="inline-flex items-center text-gray-400 hover:text-white transition-colors">
        <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i> Back to Users
    </a>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Info Card -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Profile Header -->
            <div class="bg-surface-900 rounded-xl border border-white/5 p-6">
                <div class="flex items-start gap-6">
                    <img src="{{ user.primary_photo_url }}" alt="" class="w-24 h-24 rounded-xl object-cover border border-white/10">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <h2 class="text-2xl font-bold text-white">{{ user.profile.first_name if user.profile else 'No name' }}</h2>
                            {% if user.profile and user.profile.age %}
                            <span class="text-gray-400">{{ user.profile.age }} yrs</span>
                            {% endif %}
                        </div>
                        <p class="text-gray-400 text-sm mb-3">{{ user.email }}</p>
                        
                        <!-- Status Badges -->
                        <div class="flex flex-wrap gap-2">
                            {% if not user.is_active %}
                            <span class="px-3 py-1 rounded-full text-xs font-bold bg-red-900/30 text-red-400 border border-red-500/30">
                                SUSPENDED
                            </span>
                            {% endif %}
                            {% if user.is_admin %}
                            <span class="px-3 py-1 rounded-full text-xs font-bold bg-purple-900/30 text-purple-400 border border-purple-500/30">
                                ADMIN
                            </span>
                            {% endif %}
                            {% if user.is_verified %}
                            <span class="px-3 py-1 rounded-full text-xs font-bold bg-green-900/30 text-green-400 border border-green-500/30">
                                VERIFIED
                            </span>
                            {% elif user.is_approved %}
                            <span class="px-3 py-1 rounded-full text-xs font-bold bg-blue-900/30 text-blue-400 border border-blue-500/30">
                                APPROVED
                            </span>
                            {% else %}
                            <span class="px-3 py-1 rounded-full text-xs font-bold bg-yellow-900/30 text-yellow-400 border border-yellow-500/30">
                                PENDING APPROVAL
                            </span>
                            {% endif %}
                            {% if user.is_premium %}
                            <span class="px-3 py-1 rounded-full text-xs font-bold bg-amber-900/30 text-amber-400 border border-amber-500/30">
                                PREMIUM
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Details -->
            {% if user.profile %}
            <div class="bg-surface-900 rounded-xl border border-white/5 p-6">
                <h3 class="text-lg font-bold text-white mb-4">Profile Information</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <div>
                        <p class="text-gray-500 text-xs uppercase mb-1">Gender</p>
                        <p class="text-white">{{ user.profile.gender|capitalize if user.profile.gender else 'Not set' }}</p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-xs uppercase mb-1">Location</p>
                        <p class="text-white">{{ user.profile.city }}, {{ user.profile.state }}</p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-xs uppercase mb-1">Denomination</p>
                        <p class="text-white">{{ user.profile.denomination or 'Not set' }}</p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-xs uppercase mb-1">Occupation</p>
                        <p class="text-white">{{ user.profile.occupation or 'Not set' }}</p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-xs uppercase mb-1">Education</p>
                        <p class="text-white">{{ user.profile.education or 'Not set' }}</p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-xs uppercase mb-1">Height</p>
                        <p class="text-white">{{ user.profile.height_cm }} cm</p>
                    </div>
                </div>
                
                {% if user.profile.bio %}
                <div class="mt-4 pt-4 border-t border-white/5">
                    <p class="text-gray-500 text-xs uppercase mb-1">Bio</p>
                    <p class="text-gray-300">{{ user.profile.bio }}</p>
                </div>
                {% endif %}
            </div>

            <!-- Photos -->
            <div class="bg-surface-900 rounded-xl border border-white/5 p-6">
                <h3 class="text-lg font-bold text-white mb-4">Photos ({{ user.photos|length }})</h3>
                <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3">
                    {% for photo in user.photos %}
                    <div class="relative group">
                        <img src="{{ photo.url }}" alt="" class="w-full aspect-square rounded-lg object-cover border border-white/10">
                        {% if photo.is_primary %}
                        <span class="absolute top-1 left-1 px-1.5 py-0.5 bg-amber-500 text-black text-[10px] font-bold rounded">Primary</span>
                        {% endif %}
                    </div>
                    {% else %}
                    <p class="text-gray-500 col-span-full">No photos uploaded</p>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div class="bg-surface-900 rounded-xl border border-white/5 p-6 text-center">
                <p class="text-gray-500">This user has not created a profile yet.</p>
            </div>
            {% endif %}

            <!-- User's Matches -->
            {% if user_matches %}
            <div class="bg-surface-900 rounded-xl border border-pink-500/30 p-6">
                <h3 class="text-lg font-bold text-pink-400 mb-4 flex items-center justify-between">
                    <span class="flex items-center">
                        <i data-lucide="heart" class="w-5 h-5 mr-2"></i>
                        Matches ({{ matches_count }})
                    </span>
                    {% if matches_count > 10 %}
                    <a href="{{ url_for('admin.matches', q=user.email) }}" class="text-xs text-pink-400 hover:text-pink-300">View All →</a>
                    {% endif %}
                </h3>
                <div class="space-y-3">
                    {% for match in user_matches %}
                    {% set other_user = match.user2 if match.user1_id == user.id else match.user1 %}
                    <div class="bg-surface-950 rounded-lg p-4 border border-white/5 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <img src="{{ other_user.primary_photo_url }}" alt="" class="w-10 h-10 rounded-full object-cover border border-white/10">
                            <div>
                                <a href="{{ url_for('admin.user_detail', user_id=other_user.id) }}" class="text-white font-medium hover:text-amber-400 transition-colors">
                                    {{ other_user.profile.first_name if other_user.profile else other_user.email.split('@')[0] }}
                                </a>
                                <p class="text-gray-500 text-xs">{{ match.matched_at.strftime('%b %d, %Y') if match.matched_at else 'Unknown' }}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            {% if match.is_active %}
                            <span class="px-2 py-0.5 rounded text-xs font-medium bg-green-900/30 text-green-400">Active</span>
                            {% else %}
                            <span class="px-2 py-0.5 rounded text-xs font-medium bg-red-900/30 text-red-400">Unmatched</span>
                            {% endif %}
                            <a href="{{ url_for('admin.conversation_detail', match_id=match.id) }}" 
                               class="p-1.5 bg-surface-800 hover:bg-surface-700 rounded-lg transition-colors" title="View Conversation">
                                <i data-lucide="message-circle" class="w-4 h-4 text-purple-400"></i>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Reports About This User -->
            {% if reports_about %}
            <div class="bg-surface-900 rounded-xl border border-red-500/30 p-6">
                <h3 class="text-lg font-bold text-red-400 mb-4 flex items-center">
                    <i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i>
                    Reports About This User ({{ reports_about|length }})
                </h3>
                <div class="space-y-3">
                    {% for report in reports_about %}
                    <div class="bg-surface-950 rounded-lg p-4 border border-white/5">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="text-xs text-gray-500">{{ report.created_at.strftime('%b %d, %Y') if report.created_at else 'Recently' }}</span>
                                <p class="text-white font-medium mt-1">{{ report.reason }}</p>
                                {% if report.description %}
                                <p class="text-gray-400 text-sm mt-1">{{ report.description }}</p>
                                {% endif %}
                            </div>
                            <span class="px-2 py-0.5 rounded text-xs font-medium 
                                {{ 'bg-yellow-900/30 text-yellow-400' if report.status == 'pending' else 
                                   'bg-green-900/30 text-green-400' if report.status == 'resolved' else 
                                   'bg-gray-900/30 text-gray-400' }}">
                                {{ report.status|capitalize }}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Quick Stats -->
            <div class="bg-surface-900 rounded-xl border border-white/5 p-6">
                <h3 class="text-lg font-bold text-white mb-4">Activity Stats</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Matches</span>
                        <span class="text-white font-bold">{{ matches_count }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Messages Sent</span>
                        <span class="text-white font-bold">{{ messages_sent }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Reports Made</span>
                        <span class="text-white font-bold">{{ reports_made }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Super Likes Left</span>
                        <span class="text-white font-bold">{{ user.super_likes_remaining }}</span>
                    </div>
                </div>
            </div>

            <!-- Timestamps -->
            <div class="bg-surface-900 rounded-xl border border-white/5 p-6">
                <h3 class="text-lg font-bold text-white mb-4">Timestamps</h3>
                <div class="space-y-3 text-sm">
                    <div>
                        <p class="text-gray-500 text-xs uppercase mb-1">Created</p>
                        <p class="text-white">{{ user.created_at.strftime('%b %d, %Y at %H:%M') if user.created_at else 'Unknown' }}</p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-xs uppercase mb-1">Last Active</p>
                        <p class="text-white">{{ user.last_active.strftime('%b %d, %Y at %H:%M') if user.last_active else 'Never' }}</p>
                    </div>
                    {% if user.email_verified_at %}
                    <div>
                        <p class="text-gray-500 text-xs uppercase mb-1">Email Verified</p>
                        <p class="text-white">{{ user.email_verified_at.strftime('%b %d, %Y') }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Admin Actions -->
            <div class="bg-surface-900 rounded-xl border border-white/5 p-6">
                <h3 class="text-lg font-bold text-white mb-4">Admin Actions</h3>
                <div class="space-y-3">
                    <!-- Approve (if pending) -->
                    {% if not user.is_approved %}
                    <form method="POST" action="{{ url_for('admin.approve_user', user_id=user.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" onclick="return confirm('Approve this user?')"
                                class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-medium transition-colors flex items-center justify-center">
                            <i data-lucide="check" class="w-4 h-4 mr-2"></i> Approve User
                        </button>
                    </form>
                    {% endif %}

                    <!-- Toggle Active -->
                    <form method="POST" action="{{ url_for('admin.toggle_user_active', user_id=user.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" onclick="return confirm('{{ 'Suspend' if user.is_active else 'Reactivate' }} this user?')"
                                class="w-full {{ 'bg-red-600 hover:bg-red-700' if user.is_active else 'bg-green-600 hover:bg-green-700' }} text-white py-2 rounded-lg font-medium transition-colors flex items-center justify-center">
                            <i data-lucide="{{ 'ban' if user.is_active else 'check' }}" class="w-4 h-4 mr-2"></i>
                            {{ 'Suspend User' if user.is_active else 'Reactivate User' }}
                        </button>
                    </form>

                    <!-- Toggle Verified -->
                    <form method="POST" action="{{ url_for('admin.toggle_user_verified', user_id=user.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit"
                                class="w-full bg-surface-800 hover:bg-surface-700 text-white py-2 rounded-lg font-medium transition-colors flex items-center justify-center">
                            <i data-lucide="badge-check" class="w-4 h-4 mr-2"></i>
                            {{ 'Remove Verification' if user.is_verified else 'Verify User' }}
                        </button>
                    </form>

                    <!-- Toggle Premium -->
                    <form method="POST" action="{{ url_for('admin.toggle_user_premium', user_id=user.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit"
                                class="w-full bg-amber-600 hover:bg-amber-700 text-white py-2 rounded-lg font-medium transition-colors flex items-center justify-center">
                            <i data-lucide="crown" class="w-4 h-4 mr-2"></i>
                            {{ 'Remove Premium' if user.is_premium else 'Grant Premium' }}
                        </button>
                    </form>

                    <!-- Toggle Admin -->
                    <form method="POST" action="{{ url_for('admin.toggle_user_admin', user_id=user.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" onclick="return confirm('{{ 'Remove admin' if user.is_admin else 'Grant admin' }} access?')"
                                class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-medium transition-colors flex items-center justify-center">
                            <i data-lucide="shield" class="w-4 h-4 mr-2"></i>
                            {{ 'Remove Admin' if user.is_admin else 'Make Admin' }}
                        </button>
                    </form>

                    <div class="border-t border-white/10 pt-3 mt-3"></div>

                    <!-- Delete User -->
                    <form method="POST" action="{{ url_for('admin.delete_user', user_id=user.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" onclick="return confirm('⚠️ PERMANENTLY DELETE {{ user.email }}?\\n\\nThis cannot be undone!') && prompt('Type DELETE to confirm') === 'DELETE'"
                                class="w-full bg-red-900/50 hover:bg-red-900 text-red-400 py-2 rounded-lg font-medium transition-colors flex items-center justify-center border border-red-500/30">
                            <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i> Delete User
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
